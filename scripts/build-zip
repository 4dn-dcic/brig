if [ "$(basename $(dirname $(pwd)))" != "functions" ]; then
    echo 'This script only works if your working directory is that of a'
    echo 'lambda function. That is, you must be in a folder whose'
    echo 'grandparent is named "functions".'
    exit 1
fi

commit_id=`git describe --always --dirty`

dirty_flag=`echo ${commit_id} | cut -c 8-`

if [ -n "${dirty_flag}" ]; then
    echo "Changes have been made to this repository that are not checked in."
    exit 1
fi

archive_name="$(date "+%m%d%H%M%Y%S")-${commit_id}.zip"

# Make a fresh tmp dir to work with.

if [ -e 'tmp' ]; then
    rm -rf tmp
fi

mkdir tmp

if [ ! -e 'builds' ]; then

    mkdir builds

fi


# Copy all sources to tmp/

echo "Building zip ${archive_name} ..."

cp src/* tmp/

pushd tmp > /dev/null

# Following advice from
# https://aws.amazon.com/premiumsupport/knowledge-center/build-python-lambda-deployment-package/

if [ -e "../requirements.txt" ]; then

    echo "Installing requirements ..."

    pip install -r ../requirements.txt -t ./

    echo "Requirements installed."

else

    echo "No requirements.txt found."

fi

chmod -R 755 .

zip -r ../${archive_name} .

popd  > /dev/null

mv "${archive_name}" builds/

pushd builds/ > /dev/null

if [ -e ${current} ]; then

  mv current previous

fi


ln -f -s "${archive_name}" current

popd > /dev/null

echo "builds/${archive_name} created."
